<!DOCTYPE html>
<html lang="zh-cn">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="">
  <title>【译】使用rust来写一个容器(二) | Vanitas笔记</title>
  <meta name="author" content="Vanitas" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="Docker, rust" />
  
  <meta name="description" content="注              本文章为对 Litchi Pi的《Writing a container in Rust》的翻译转载，不享受任何著作权利，不用于任何商业目的，不以任何许可证进行授权，不对任何转载行为尤其是商业转载行为负责。一切权利均由原作者 Litchi Pi 保有。个人翻译能力有限，如有疑问可查看原文。             开始项目在这篇文章中,我们将为我们的实现做好">
<meta property="og:type" content="article">
<meta property="og:title" content="【译】使用rust来写一个容器(二)">
<meta property="og:url" content="http://srcchen.github.io/2023/09/02/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A82/index.html">
<meta property="og:site_name" content="Vanitas笔记">
<meta property="og:description" content="注              本文章为对 Litchi Pi的《Writing a container in Rust》的翻译转载，不享受任何著作权利，不用于任何商业目的，不以任何许可证进行授权，不对任何转载行为尤其是商业转载行为负责。一切权利均由原作者 Litchi Pi 保有。个人翻译能力有限，如有疑问可查看原文。             开始项目在这篇文章中,我们将为我们的实现做好">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://srcchen.github.io/null">
<meta property="article:published_time" content="2023-09-01T16:00:00.000Z">
<meta property="article:modified_time" content="2023-09-02T19:52:14.130Z">
<meta property="article:author" content="Vanitas">
<meta property="article:tag" content="rust">
<meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://srcchen.github.io/null">
<meta name="twitter:site" content="@null">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" type="text/css" media="all">
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" type="text/css" media="all">
  
  
  <link rel="stylesheet" id="fontawe-css" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" type="text/css" media="all">
  <link rel="stylesheet" id="nprogress-css" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" type="text/css" media="all">
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-dark.min.css" type="text/css" media="all">
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/qrcode_js@1.0.0/qrcode.min.js"></script>
  
<meta name="generator" content="Hexo 5.4.2"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                        <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                    
                                
                                    
                                        <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">Vanitas笔记</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>Vanitas笔记</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        <section class="col-md-8">
    <article>
        <div class="kratos-hentry kratos-post-inner clearfix">
            <header class="kratos-entry-header">
                
                    <h1 class="kratos-entry-title text-center">【译】使用rust来写一个容器(二)</h1>
                
                
                <ul class="kratos-post-meta text-center">
                    <li><i class="fa fa-calendar"></i> 2023-09-02</li>
                    <li><i class="fa fa-user"></i> 作者 Vanitas</li>
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~10.24K
                        
                        字
                    </li>
                    
                </ul>
            </header>
            <div class="kratos-post-content">
                <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                    本文最后编辑于 <time datetime="1693684334130"></time> 前，其中的内容可能需要更新。
                </div>
                
                    <div class="kratos-post-inner-toc">
                        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">开始项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%8F%82%E6%95%B0"><span class="toc-number">1.2.</span> <span class="toc-text">解析参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#structopt%E5%BA%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text">structopt库介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.2.</span> <span class="toc-text">创建我们自己的参数解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.3.</span> <span class="toc-text">测试我们的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">1.3.</span> <span class="toc-text">添加日志记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.1.</span> <span class="toc-text">添加日志记录功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.2.</span> <span class="toc-text">记录日志信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-1"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">准备错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Errcode-%E6%9E%9A%E4%B8%BE"><span class="toc-number">1.4.1.</span> <span class="toc-text">Errcode 枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E8%BF%94%E5%9B%9E%E7%A0%81"><span class="toc-number">1.4.2.</span> <span class="toc-text">Linux返回码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rust%E4%B8%AD%E7%9A%84Result"><span class="toc-number">1.4.3.</span> <span class="toc-text">Rust中的Result</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-2"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0"><span class="toc-number">1.5.</span> <span class="toc-text">校验参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-3"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li></ol></li></ol>
                    </div>
                
                <hr />
                <div class="panel panel-info">
    <div class="panel-title">注</div>
    <div class="panel-body">
        <p>本文章为对 <code>Litchi Pi</code>的<a target="_blank" rel="noopener" href="https://litchipi.site/">《Writing a container in Rust》</a>的翻译转载，不享受任何著作权利，不用于任何商业目的，不以任何许可证进行授权，不对任何转载行为尤其是商业转载行为负责。一切权利均由原作者 Litchi Pi 保有。个人翻译能力有限，如有疑问可查看原文。</p>

    </div>
    </div>

<h1 id="开始项目"><a href="#开始项目" class="headerlink" title="开始项目"></a>开始项目</h1><p>在这篇文章中,我们将为我们的实现做好准备。<br>每个程序员都各自有不同的习惯，一些人可能会直接通过Linux的系统调用来创建一个隔离的box。而我则更喜欢创建一个干净的基础环境来做我自己的实现,我发现这么做更有利于以后的阅读和理解,并且做干净的实现总是好事。<br>同样的，这也能提供一些rust新手感兴趣的额外的一些tips和工具,比如<strong>参数解析</strong>、<strong>错误处理</strong>和<strong>日志记录</strong>等等.</p>
<p>在阅读这篇文章之前,我假定你们已经安装好了<code>rustc</code>以及<code>cargo</code>,如果你没有安装这两个工具,请按照<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/ch01-01-installation.html">本书说明</a>进行操作。</p>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>我猜你已经听说过Rust的吉祥物是<strong>Ferris</strong>这只又小又可爱的螃蟹了。<br>好,让我们吧Ferris放进容器里吧！:D</p>
<img src="/2023/09/02/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A82/crabcan.png" class="" title="crabcan">

<p>我们将创建一个名为<strong>Crabcan</strong>的Rust binary项目，目标是尽可能对这个项目的不同部分进行拆分，以便于我们在代码中进行搜索和调整，以及在数月的暂停后也能对项目很好的重新理解。</p>
<p>首先我们运行<code>cargo new --bin crabcan</code>来创建这个项目。<br>这个命令会生成一个<code>Cargo.toml</code>文件,我们可以通过这个文件来为项目添加描述、添加依赖项、调整Rust编译器配置。它能避免我们手动在Makefile中创建rustc命令，是一个很方便的文件。你现在可以在这个文件中修改作者的名字和邮箱、版本等，不过目前我们还不会在这个文件中添加任何依赖项。<br>在文件夹<code>src/</code>中，您将放置所有源代码。不过目前只有一个写了<code>Hello World!</code>代码的<code>main.rs</code>文件在这个文件夹里。</p>
<h2 id="解析参数"><a href="#解析参数" class="headerlink" title="解析参数"></a>解析参数</h2><p>OK,现在我们直接打开我们的项目。首先我们要从命令行获取参数。<br>目标是在调用我们的工具时从给出的文本形式的的flag中获取配置。</p>
<p>命令执行例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crabcan --mount ./mountdir/ --uid 0 --debug --command &quot;bash&quot;</span><br></pre></td></tr></table></figure>
<p>这个命令会调用<code>crabcan</code>,以root身份将<code>mountdir</code>挂载到容器根目录,UID为<code>0</code>,输出所有<code>debug</code>消息，并将在容器内执行命令<code>bash</code>。</p>
<h3 id="structopt库介绍"><a href="#structopt库介绍" class="headerlink" title="structopt库介绍"></a><code>structopt</code>库介绍</h3><p><a target="_blank" rel="noopener" href="https://crates.io/crates/structopt">structopt</a>库是一个用于解析来自命令行的参数非常有用的工具（底层使用了clap库）。 使用方法非常简单，我们只需要定义一个包含所有参数的<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/book/ch05-01-defining-structs.html">结构体</a>：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[derive(Debug, StructOpt)]</span></span><br><span class="line"><span class="meta">#[structopt(name = <span class="meta-string">&quot;example&quot;</span>, about = <span class="meta-string">&quot;An example of StructOpt usage.&quot;</span>)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Opt</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Activate debug mode</span></span><br><span class="line">    <span class="comment">// short and long flags (-d, --debug) will be deduced from the field&#x27;s name </span></span><br><span class="line">    <span class="meta">#[structopt(short, long)]</span></span><br><span class="line">    debug: <span class="built_in">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// etc ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>structopt的详细用法和所有功能可在其<a target="_blank" rel="noopener" href="https://docs.rs/structopt/latest/structopt/">文档</a>中找到。值得注意的是，结构体中定义的参数上方的<code>/// text</code>部分将用作帮助信息（例：当输入<code>crabcan --help</code>时出现的信息）。</p>
<h3 id="创建我们自己的参数解析"><a href="#创建我们自己的参数解析" class="headerlink" title="创建我们自己的参数解析"></a>创建我们自己的参数解析</h3><p>我们需要先创建一个新文件<code>src/cli.rs</code>,这个文件中包含了与命令行相关的全部内容。为了在我们的项目中使用它，我们必须先将他作为一个模块来引入到我们的项目中。</p>
<p>我们先在<code>src/main.rs</code>中把文本替换为以下内容:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> cli;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> args = cli::parse_args();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们期望<code>src/cli.rs</code>能提供一个基础的<code>parse_args</code>函数,这个函数会返回包含所有我们通过命令行定义的配置的结构体。<br><em>注意:由于<code>args</code>并没有被使用，你会看见编译器出现的对应warning</em></p>
<p>现在让我们在<code>src/cli.rs</code>中实现这个<code>parse_args</code>函数:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::path::PathBuf;</span><br><span class="line"><span class="keyword">use</span> structopt::StructOpt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, StructOpt)]</span></span><br><span class="line"><span class="meta">#[structopt(name = <span class="meta-string">&quot;crabcan&quot;</span>, about = <span class="meta-string">&quot;A simple container in Rust.&quot;</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Args</span></span> &#123;</span><br><span class="line">    <span class="comment">/// Activate debug mode</span></span><br><span class="line">    <span class="meta">#[structopt(short, long)]</span></span><br><span class="line">    debug: <span class="built_in">bool</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Command to execute inside the container</span></span><br><span class="line">    <span class="meta">#[structopt(short, long)]</span></span><br><span class="line">    <span class="keyword">pub</span> command: <span class="built_in">String</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// User ID to create inside the container</span></span><br><span class="line">    <span class="meta">#[structopt(short, long)]</span></span><br><span class="line">    <span class="keyword">pub</span> uid: <span class="built_in">u32</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Directory to mount as root of the container</span></span><br><span class="line">    <span class="meta">#[structopt(parse(from_os_str), short = <span class="meta-string">&quot;m&quot;</span>, long = <span class="meta-string">&quot;mount&quot;</span>)]</span></span><br><span class="line">    <span class="keyword">pub</span> mount_dir: PathBuf,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">parse_args</span></span>() -&gt; Args &#123;</span><br><span class="line">    <span class="keyword">let</span> args = Args::from_args();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If args.debug: Setup log at debug level</span></span><br><span class="line">    <span class="comment">// Else: Setup log at info level</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate arguments</span></span><br><span class="line"></span><br><span class="line">    args</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里 我们必须导入我们必需的依赖库<code>structopt</code>以及在标准库中的<code>PathBuf</code><br>接下来我们定义<code>Args</code>结构体，它包含了所有参数以及用于解析参数的信息，让我们先来看看我们需要哪些参数：</p>
<ul>
<li><code>debug</code>:     用于显示调试消息或仅显示正常日志</li>
<li><code>command</code>:   在容器内执行的命令（带参数）</li>
<li><code>uid</code>:       在容器内作为应用运行用户的userID</li>
<li><code>mount_dir</code>: 用作容器内根目录<code>/</code>的文件夹。</li>
</ul>
<p><em>注意：这个参数会以命令行中<strong>mount</strong>的形式来传递</em></p>
<p>这些加上了<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/stable/book/ch19-06-macros.html#attribute-like-macros">宏属性(macro attribute)</a><code>structopt(short, long)</code>定义的参数，会根据字段名称来自动创建对应的short命令行参数和long命令行参数。（如字段 toto 将被定义为参数 -t 和 –toto）。</p>
<p>终于，我们创建了<code>parse_args</code>函数，它通过结构体的<code>from_args</code>函数(由<code>derive(StructOpt)</code>宏生成)中来获取命令行参数。</p>
<p>在为参数验证和日志初始化设置一些占位符后，我们将参数返回。</p>
<p>最后我们把刚刚引入的包在<code>Cargo.toml</code>文件中作为依赖引入:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ...</span><br><span class="line">[dependencies]</span><br><span class="line">structopt = <span class="string">&quot;0.3.23&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="测试我们的代码"><a href="#测试我们的代码" class="headerlink" title="测试我们的代码"></a>测试我们的代码</h3><p>让我们使用<code>cargo run</code>来运行我们的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">error: The following required arguments were not provided:</span><br><span class="line">    --command &lt;command&gt;</span><br><span class="line">    --mount &lt;mount-dir&gt;</span><br><span class="line">    --uid &lt;uid&gt;</span><br><span class="line"></span><br><span class="line">USAGE:</span><br><span class="line">    crabcan [FLAGS] --command &lt;command&gt; --mount &lt;mount-dir&gt; --uid &lt;uid&gt;</span><br><span class="line"></span><br><span class="line">For more information try --help</span><br></pre></td></tr></table></figure>
<p>就是这样,我们的参数解析功能运行成功了！现在如果我们尝试运行<code>cargo run -- --mount ./ --uid 0 --command &quot;bash&quot; --debug</code>的话,不会出现任何错误，你也可以在我们的<code>src/main.rs</code>中添加<code>println!(&quot;&#123;:?&#125;&quot;, args)</code>来得到还不错的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Args &#123; debug: true, command: &quot;bash&quot;, uid: 0, mount_dir: &quot;./&quot; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Patch-for-this-step"><a href="#Patch-for-this-step" class="headerlink" title="Patch for this step"></a>Patch for this step</h4><p>这一步的代码可以在github <a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/tree/step1">litchipi/crabcan branch “step1”</a>中找到.<br>应用于<code>cargo new --bin</code>创建的新项目的原始补丁可以在<a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/compare/main..step1.diff">此处</a>找到</p>
<h2 id="添加日志记录"><a href="#添加日志记录" class="headerlink" title="添加日志记录"></a>添加日志记录</h2><p>现在我们已经成功获得了用户的输入信息，让我们用某些方式来为他提供输出。其实需要简单的文本就足够满足需求，但是我希望能将调试信息与基础的输出信息以及错误信息分开。因此，尽管有很多工具可供选择，但我选择了<code>log</code>库和<code>env_logger</code>库来实现这个功能。</p>
<p><a target="_blank" rel="noopener" href="https://crates.io/crates/log">log库</a>是一个非常流行的日志工具。 它提供了一个<code>Log</code>trait(请参阅<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/ch10-02-traits.html">此处</a>来获取trait的解释），它定义了日志记录工具必须具有的所有功能，并允许任何其他crate实现这些功能。我选择了<a target="_blank" rel="noopener" href="https://crates.io/crates/env_logger">env_logger库</a>来实现这些功能。</p>
<p>我们在<code>Cargo.toml</code>添加下面的依赖:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># ...</span><br><span class="line">log = &quot;0.4.14&quot;</span><br><span class="line">env_logger = &quot;0.9.0&quot;</span><br></pre></td></tr></table></figure>
<h3 id="添加日志记录功能"><a href="#添加日志记录功能" class="headerlink" title="添加日志记录功能"></a>添加日志记录功能</h3><p>日志记录工具必须设置一个详细程度等级来进行初始化，这个等级定义了是否显示调试信息、仅显示错误信息或者是完全不显示日志信息。在我们的例子中,我们希望它在默认的情况下显示普通信息,并在我们通过命令行传递了<code>--debug</code>标志的情况下提高debug信息的详细程度。</p>
<p>让我们在<code>src/cli.rs</code>中初始化我们的日志记录器:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">setup_log</span></span>(level: log::LevelFilter)&#123;</span><br><span class="line">    env_logger::Builder::from_default_env()</span><br><span class="line">        .format_timestamp_secs()</span><br><span class="line">        .filter(<span class="literal">None</span>, level)</span><br><span class="line">        .init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>诚然,将它单独作为一个函数可能并不是很有必要,但是这么做的话代码会更有可读性,不是吗？<br>如果你对<a target="_blank" rel="noopener" href="https://gist.github.com/jFransham/369a86eff00e5f280ed25121454acec1">Rust代码优化</a>感兴趣的话，你可能想<a target="_blank" rel="noopener" href="https://nnethercote.github.io/perf-book/inlining.html">内联这个函数</a>。</p>
<div class="panel panel-info">
    <div class="panel-title">译者注</div>
    <div class="panel-body">
        <p>关于内联函数,也可查看这篇中文翻译[Rust 中的内联](<a target="_blank" rel="noopener" href="https://nihil.cc/posts/translate_rust_inline/">https://nihil.cc/posts/translate_rust_inline/</a></p>

    </div>
    </div>

<p>OK，现在我们需要在从命令行获取到参数后立刻初始化日志记录,让我们在<code>parse_args</code>函数中 用这段代码替换之前我们保留的占位符:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.debug&#123;</span><br><span class="line">    setup_log(log::LevelFilter::<span class="built_in">Debug</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    setup_log(log::LevelFilter::Info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="记录日志信息"><a href="#记录日志信息" class="headerlink" title="记录日志信息"></a>记录日志信息</h3><p>现在一切都就绪l，让我们在终端中记录一些内容！在<code>src/main.rs</code>的<code>main</code>函数中，我们可以将获取的参数输出到<code>info</code>信息中。这可以通过<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/ch19-06-macros.html"><code>log::info!</code>宏</a>来实现</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log::info!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, args);</span><br></pre></td></tr></table></figure>
<p><code>log</code>库给我们提供了<code>error!</code>、<code>warn!</code>、<code>info!</code>、<code>debug!</code>、<code>trace!</code>五个级别。</p>
<p>测试后我们将得到输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2021-09-30T10:17:46Z INFO  crabcan] Args &#123; debug: true, command: &quot;/bin/bash&quot;, uid: 0, mount_dir: &quot;./mountdir/&quot; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="Patch-for-this-step-1"><a href="#Patch-for-this-step-1" class="headerlink" title="Patch for this step"></a>Patch for this step</h4><p>这一步的代码可以在github <a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/tree/step2">litchipi/crabcan branch “step2”</a>中找到.<br>从前一步到这一步的原始补丁可以在<a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/compare/step1..step2.diff">此处</a>找到。</p>
<h2 id="准备错误处理"><a href="#准备错误处理" class="headerlink" title="准备错误处理"></a>准备错误处理</h2><p>作为通常的练习,注意错误处理会是一个好习惯。Rust这门语言在错误处理方面非常强大,以至于我们无法在错误处理上忽略或者遗漏这个特点。</p>
<h3 id="Errcode-枚举"><a href="#Errcode-枚举" class="headerlink" title="Errcode 枚举"></a>Errcode 枚举</h3><p>让我们创建一个定义了如下<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/ch06-01-defining-an-enum.html">enum(枚举)</a>的<code>src/errors.rs</code>文件:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allows to display a variant with the format &#123;:?&#125;</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="comment">// Contains all possible errors in our tool</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Errcode</span></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次我们添加新的错误类型时，我们都会向该enum添加一个可变体(variant)。<code>derive(Debug)</code>允许使用<code>&#123;:?&#125;</code>来格式化显示enum。</p>
<p>我们可能希望为每个可变体显示更完整的消息，以防我们在项目中的代码和数字使我们晕头转向。为此，让我们来实现<code>std::fmt::Display</code>特性，定义该对象尝试在常规<code>&#123;&#125;</code>格式中显示时的行为。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[allow(unreachable_patterns)]</span></span><br><span class="line"><span class="comment">// trait Display, allows Errcode enum to be displayed by:</span></span><br><span class="line"><span class="comment">//      println!(&quot;&#123;&#125;&quot;, error);</span></span><br><span class="line"><span class="comment">//  in this case, it calls the function &quot;fmt&quot;, which we define the behaviour below</span></span><br><span class="line"><span class="keyword">impl</span> fmt::Display <span class="keyword">for</span> Errcode &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fmt</span></span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter&lt;<span class="symbol">&#x27;_</span>&gt;) -&gt; fmt::<span class="built_in">Result</span> &#123;</span><br><span class="line">        <span class="comment">// Define what behaviour for each variant of the enum</span></span><br><span class="line">        <span class="keyword">match</span> &amp;<span class="keyword">self</span>&#123;</span><br><span class="line">            _ =&gt; <span class="built_in">write!</span>(f, <span class="string">&quot;&#123;:?&#125;&quot;</span>, <span class="keyword">self</span>) <span class="comment">// For any variant not previously covered</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>unreachable_patterns</code> 属性确保在<code>match</code>语句描述了所有可变体时，不会收到编译器的任何警告信息。</p>
</blockquote>
<h3 id="Linux返回码"><a href="#Linux返回码" class="headerlink" title="Linux返回码"></a>Linux返回码</h3><p>Linux可执行文件在退出时会返回一个数字，它描述了一切的进展情况。 返回代码 0 表示没有错误，任何其他数字都用于描述错误以及该错误的详情（基于返回代码值）。 您可以在<a target="_blank" rel="noopener" href="https://tldp.org/LDP/abs/html/exitcodes.html">此处</a>找到有关特殊返回代码及其含义的表。</p>
<p>我们并不追求通过我们的工具来执行bash自动化脚本,只要设置一个如果有错误则返回1,没有错误则返回0的方式就可以了。</p>
<p>让我们在<code>src/errors.rs</code>文件中定义一个<code>exit_with_errcode</code>函数:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::process::exit;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get the result from a function, and exit the process with the correct error code</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">exit_with_retcode</span></span>(res: <span class="built_in">Result</span>&lt;(), Errcode&gt;) &#123;</span><br><span class="line">    <span class="keyword">match</span> res &#123;</span><br><span class="line">        <span class="comment">// If it&#x27;s a success, return 0</span></span><br><span class="line">        <span class="literal">Ok</span>(_) =&gt; &#123;</span><br><span class="line">            log::debug!(<span class="string">&quot;Exit without any error, returning 0&quot;</span>);</span><br><span class="line">            exit(<span class="number">0</span>);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there&#x27;s an error, print an error message and return the retcode</span></span><br><span class="line">        <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> retcode = e.get_retcode();</span><br><span class="line">            log::error!(<span class="string">&quot;Error on exit:\n\t&#123;&#125;\n\tReturning &#123;&#125;&quot;</span>, e, retcode);</span><br><span class="line">            exit(retcode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数会使用我们在<code>Errcode</code>这个enum中实现的<code>get_retcode</code>函数提供的返回状态码来退出进程，让我们先用最简单夜色最笨的办法来实现它:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Errcode&#123;</span><br><span class="line">    <span class="comment">// Translate an Errcode::X into a number to return (the Unix way)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_retcode</span></span>(&amp;<span class="keyword">self</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">        <span class="number">1</span> <span class="comment">// Everything != 0 will be treated as an error</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Rust中的Result"><a href="#Rust中的Result" class="headerlink" title="Rust中的Result"></a>Rust中的Result</h3><p>当一段代码无法正常工作时,我们可以通过Rust中的Result来进行错误处理(详情请参阅<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/book/ch09-02-recoverable-errors-with-result.html">此处</a>)<br><code>Result&lt;T, U&gt;</code>需要两种类型，一种是成功时返回的<code>T</code>类型，一种是发生错误时返回的<code>U</code>类型。在我们的例子中，如果出现错误，我们希望返回<code>Errcode</code>，如果一切顺利，则返回我们想要的任何内容。<br>让我们看看我们怎么在<code>parse_args</code>函数中进行设置：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">parse_args</span></span>() -&gt; <span class="built_in">Result</span>&lt;Args, Errcode&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="literal">Ok</span>(args)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果在程序运行过程中出现了某种错误,我们只要简单写上:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="literal">Err</span>(Errcode::MyErrorType);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Rust中的<code>Result</code>非常有用而且强大,一般来说。通常在任何你想要错误处理的地方使用都是个好主意,因为这是Rust中错误处理的标准方式。</p>
</blockquote>
<p>OK,现在我们需要在<code>main</code>函数中对函数成功或者失败两种状态分别做不同的处理,让我们使用<code>match</code>语句来定义这两种情况下要做哪些事:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> cli::parse_args()&#123;</span><br><span class="line">    <span class="literal">Ok</span>(args) =&gt; &#123;</span><br><span class="line">        log::info!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, args);</span><br><span class="line">        exit_with_retcode(<span class="literal">Ok</span>(()))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">        log::error!(<span class="string">&quot;Error while parsing arguments:\n\t&#123;&#125;&quot;</span>, e);</span><br><span class="line">        exit(e.get_retcode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在这段代码中,如果参数解析成功,那么我们在日志中打印参数并使用<code>OK()</code>作为参数来调用<code>exit_with_retcode</code>(这个函数会简单的返回0),我们稍后会将这里作为我们放置容器的起点。<br>如果出现了错误,我们会在日志中打印它(注意<code>Errcode</code>上的<code>&#123;&#125;</code>格式化方式 ，它将调用我们之前实现的<code>Display</code> trait中的 fmt 函数)然后简单地退出并返回相关的返回代码。<br>最后一步，我们必须将<code>src/errors.rs</code>设置本为项目的一个模块，并在<code>src/main.rs</code>文件中导入<code>exit_with_retcode</code>函数。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> errors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> errors::exit_with_retcode;</span><br></pre></td></tr></table></figure>

<p>在测试完成后,我们可以得到如下输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2021-09-30T13:47:45Z INFO  crabcan] Args &#123; debug: true, command: &quot;/bin/bash&quot;, uid: 0, mount_dir: &quot;./mountdir/&quot; &#125;</span><br><span class="line">[2021-09-30T13:47:45Z DEBUG crabcan::errors] Exit without any error, returning 0</span><br></pre></td></tr></table></figure>

<h4 id="Patch-for-this-step-2"><a href="#Patch-for-this-step-2" class="headerlink" title="Patch for this step"></a>Patch for this step</h4><p>这一步的代码可以在github <a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/tree/step3">litchipi/crabcan branch “step3”</a>中找到.<br>前一步到这一步的原始补丁可以在<a href="hhttps://github.com/litchipi/crabcan/compare/step2..step3.diff">此处</a>找到</p>
<blockquote>
<p>感谢<code>filtoid</code>为修复此步骤中出现的错误所提的PR</p>
</blockquote>
<h2 id="校验参数"><a href="#校验参数" class="headerlink" title="校验参数"></a>校验参数</h2><p>在我们深入实际工作之前,我们先校验一下从命令行传入的参数，此处我们仅仅检查一下<code>mount_dir</code>是否存在,不过如果有我们添加了更多选项等情况,可以通过额外的检查来对这一步进行拓展。<br>让我们用的实际参数验证代码替换<code>src/cli.rs</code>中的占位符：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">parse_args</span></span>() -&gt; <span class="built_in">Result</span>&lt;Args, Errcode&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> !args.mount_dir.exists() || !args.mount_dir.is_dir()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">Err</span>(Errcode::ArgumentInvalid(<span class="string">&quot;mount&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个条件语句检验了路径(我们在<code>Args</code>结构体中定义的<code>PathBuf</code>类型)是否存在以及这个路径是否为目录。<br>如果不满足这个条件,我们会返回<code>Result::Err</code>以及带有自定义可变体<code>ArgumentInvalid</code>的<code>Errcode</code> enum ,指明错误发生在参数<code>mount</code>部分。<br>我们先在<code>src/errors.rs</code>中定义这个可变体:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Errcode</span></span>&#123;</span><br><span class="line">    ArgumentInvalid(&amp;<span class="symbol">&#x27;static</span> <span class="built_in">str</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们可以在<code>fmt</code>函数的<code>match</code>语句下添加以下内容:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">match</span> &amp;<span class="keyword">self</span>&#123;</span><br><span class="line">    <span class="comment">// Message to display when an argument is invalid</span></span><br><span class="line">    Errcode::ArgumentInvalid(element) =&gt; <span class="built_in">write!</span>(f, <span class="string">&quot;ArgumentInvalid: &#123;&#125;&quot;</span>, element),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Patch-for-this-step-3"><a href="#Patch-for-this-step-3" class="headerlink" title="Patch for this step"></a>Patch for this step</h4><p>这一步的代码可以在github <a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/tree/step4">litchipi/crabcan branch “step4”</a>中找到.<br>前一步到这一步的原始补丁可以在<a target="_blank" rel="noopener" href="https://github.com/litchipi/crabcan/compare/step3..step4.diff">此处</a>找到</p>
<blockquote>
<p>特别感谢 <em>@kevinji</em>指出的此步骤中的错误</p>
</blockquote>

            </div>
            
                <div class="kratos-copyright text-center clearfix">
                    <h5>本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
                </div>
            
            <footer class="kratos-entry-footer clearfix">
                
                    <div class="post-like-donate text-center clearfix" id="post-like-donate">
                    
                    
                        <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                        <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://srcchen.github.io/2023/09/02/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A82/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://srcchen.github.io/2023/09/02/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A82/";
            const title         = "「【译】使用rust来写一个容器(二)」";
            const excerpt       = `
    注
    
        本文章为对 Litchi Pi的《Writing a container in Rust》的翻译转载，不享受任何著作权利，不用于任何商业目的，不以任何许可证进行授权，不对任何转载行为尤其是商业转...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                    
                    </div>
                
                <div class="footer-tag clearfix">
                    <div class="pull-left">
                    <i class="fa fa-tags"></i>
                        <a class="tag-none-link" href="/tags/Docker/" rel="tag">Docker</a>, <a class="tag-none-link" href="/tags/rust/" rel="tag">rust</a>
                    </div>
                    <div class="pull-date">
                    <span>最后编辑：2023-09-03</span>
                    </div>
                </div>
            </footer>
        </div>
        
            <nav class="navigation post-navigation clearfix" role="navigation">
                
                <div class="nav-previous clearfix">
                    <a title=" 【译】使用rust来写一个容器(一)" href="/2023/08/31/用rust写一个容器1/">&lt; 上一篇</a>
                </div>
                
                
                <div class="nav-next clearfix">
                    <a title=" 【译】使用rust来写一个容器(三)" href="/2023/09/10/用rust写一个容器3/">下一篇 &gt;</a>
                </div>
                
            </nav>
        
        
    </article>
</section>

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/main.webp" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">向着高处挣扎本身足以填满一个人的心灵</p>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix">
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar"></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E9%A1%B9%E7%9B%AE"><span class="toc-text">开始项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%8F%82%E6%95%B0"><span class="toc-text">解析参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#structopt%E5%BA%93%E4%BB%8B%E7%BB%8D"><span class="toc-text">structopt库介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-text">创建我们自己的参数解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%88%91%E4%BB%AC%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text">测试我们的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step"><span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-text">添加日志记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E5%8A%9F%E8%83%BD"><span class="toc-text">添加日志记录功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF"><span class="toc-text">记录日志信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-1"><span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-text">准备错误处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Errcode-%E6%9E%9A%E4%B8%BE"><span class="toc-text">Errcode 枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Linux%E8%BF%94%E5%9B%9E%E7%A0%81"><span class="toc-text">Linux返回码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rust%E4%B8%AD%E7%9A%84Result"><span class="toc-text">Rust中的Result</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-2"><span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%A1%E9%AA%8C%E5%8F%82%E6%95%B0"><span class="toc-text">校验参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Patch-for-this-step-3"><span class="toc-text">Patch for this step</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/FaaS/">FaaS</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gateway/">gateway</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rust/">rust</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%B0%88/">杂谈</a><span class="category-list-count">1</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/AI/" style="font-size: 0.6em;">AI</a> <a href="/tags/DevOps/" style="font-size: 0.7em;">DevOps</a> <a href="/tags/Docker/" style="font-size: 0.73em;">Docker</a> <a href="/tags/Embedding/" style="font-size: 0.6em;">Embedding</a> <a href="/tags/FaaS/" style="font-size: 0.6em;">FaaS</a> <a href="/tags/Kubernetes/" style="font-size: 0.6em;">Kubernetes</a> <a href="/tags/Linux/" style="font-size: 0.63em;">Linux</a> <a href="/tags/ansible/" style="font-size: 0.6em;">ansible</a> <a href="/tags/docker/" style="font-size: 0.67em;">docker</a> <a href="/tags/envoy/" style="font-size: 0.6em;">envoy</a> <a href="/tags/harbor/" style="font-size: 0.6em;">harbor</a> <a href="/tags/helm/" style="font-size: 0.6em;">helm</a> <a href="/tags/ingress/" style="font-size: 0.6em;">ingress</a> <a href="/tags/kubernetes/" style="font-size: 0.8em;">kubernetes</a> <a href="/tags/prometheus/" style="font-size: 0.63em;">prometheus</a> <a href="/tags/pv/" style="font-size: 0.63em;">pv</a> <a href="/tags/pvc/" style="font-size: 0.63em;">pvc</a> <a href="/tags/rust/" style="font-size: 0.77em;">rust</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2024/10/24/Milvus%E5%90%91%E9%87%8F%E5%B5%8C%E5%85%A5/"><i class="fa  fa-book"></i> Milvus 基本使用</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/14/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A88/"><i class="fa  fa-book"></i> 【译】使用rust来写一个容器(八)</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/07/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A87/"><i class="fa  fa-book"></i> 【译】使用rust来写一个容器(七)</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/23/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A86/"><i class="fa  fa-book"></i> 【译】使用rust来写一个容器(六)</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/22/%E7%94%A8rust%E5%86%99%E4%B8%80%E4%B8%AA%E5%AE%B9%E5%99%A85/"><i class="fa  fa-book"></i> 【译】使用rust来写一个容器(五)</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        <li><a href="mailto:cg0616@hotmail.com"><i class="fa fa-envelope"></i></a></li>
                        
                        
                        
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://github.com/SRCchen"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 Vanitas笔记 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Vanitas.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="http://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>
<script>const notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));</script>

<script async src="/js/candy.min.js"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="6600958231"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>


    <script defer src="/js/kr-dark.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>